<!-- this needs to move -->
<% workspace = /(.*)\:/.match(@doc.layers.first)[1] %>

<%
    catalog = RGeoServer::Catalog.new(
      :user => ENV['GEOSERVER_USER'],
      :url => SiteConfig.geoserver_rest,
      :password=> ENV['GEOSERVER_PASSWORD'])

w = catalog.get_workspace(workspace)
ds = w.data_stores.first
ft = ds.featuretypes
@bbox = ft.first.profile['nativeBoundingBox']
%>

<div class="content">
  <h1><%= @doc.title %></h1>
 
  <div id="item_map"></div>

  <% unless @doc.web_service.first.nil? %>
     <!-- todo: fix this -->
     <% service_base = SiteConfig.geoserver_url + "/" + workspace %>
     <% box = "#{@bbox['minx']},#{@bbox['miny']},#{@bbox['maxx']},#{@bbox['maxy']}" %>

  <% wms_link = "#{service_base}/wms?request=getCapabilities"%>
  <% wfs_link = "#{service_base}/wfs?request=getCapabilities"%>

  <% layer_list = @doc.layers.to_a.join(',') %>

  <div id="arcgis_connection">
    <h3>ArcGIS Connection</h3>
    <p><strong>WMS</strong>: <a href="<%= wms_link %>"><%= wms_link %></a></p>
    <p><strong>WFS</strong>: <a href="<%= wfs_link %>"><%= wfs_link %></a></p>
  </div>

  <div id="neatline_connection">
    <h3>Neatline Connection</h3>
    <p><strong>WMS Address</strong>: <%= "#{service_base}/wms" %><p>
    <p><strong>Layers</strong>: <%= layer_list %></p>
  </div>

  <div id="layers">

    <% ft.each do |layer| %>
      <% profile = layer.profile %>
      <% bounds = profile['nativeBoundingBox'] %>
      <% box = "#{bounds['minx']},#{bounds['miny']},#{bounds['maxx']},#{bounds['maxy']}" %>

      <% pdf_link = "#{service_base}/wms?request=GetMap&layers=#{profile['name']}&bbox=#{box}&width=512&height=378&format=application/pdf" %>
      <% kml_link = "#{service_base}/wms?request=GetMap&layers=#{profile['name']}&bbox=#{box}&width=512&height=378&format=application/vnd.google-earth.kml+xml" %>
      <% jpeg_link = "#{service_base}/wms?request=GetMap&layers=#{profile['name']}&bbox=#{box}&width=512&height=378&format=image/jpeg" %>

      <p>
        <%= profile['name'] %>: <a href="<%= pdf_link %>">PDF</a> | 
        <a href="<%= jpeg_link %>">JPEG</a> |
        <a href="<%= kml_link %>">KML</a>
      </p>
    <% end %>

  </div>
<% end %>

  <h2>Abstract</h2>
  <p><%= @doc.abstract %></p>

</div>

<script>

(function() {
  "use strict";

  OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;
  OpenLayers.Util.onImageLoadErrorColor = "transparent";
  OpenLayers.ImgPath = "http://js.mapbox.com/theme/dark/";

  var bounds = new OpenLayers.Bounds(
    <%= @bbox['minx'] %>,
    <%= @bbox['miny'] %>,
    <%= @bbox['maxx'] %>,
    <%= @bbox['maxy'] %>
  );

  console.log('bounds', bounds);

    var map = new OpenLayers.Map({
      div: 'item_map',
      projection: new OpenLayers.Projection("<%= @bbox['crs'] %>"),
      displayProjection: new OpenLayers.Projection("EPSG:4326"),
      units: 'm',
      maxExtent: bounds,
      maxResolution: 'auto',
      controls: [
        new OpenLayers.Control.Attribution(),
        new OpenLayers.Control.Navigation(),
        new OpenLayers.Control.PanZoomBar(),
        new OpenLayers.Control.LayerSwitcher({
          'ascending': true,
          roundedCorner: false
        }),
        new OpenLayers.Control.ScaleLine(),
        //new OpenLayers.Control.Permalink({anchor: true}),
        new OpenLayers.Control.MousePosition()
      ],
      layers: [
        new OpenLayers.Layer.OSM()
      ]
    });

    <% @doc.layers.each do |layer| %>
      <% clean_layer = /\:(.*)/.match(layer.text)[1].to_s %>

      var <%= clean_layer %> = new OpenLayers.Layer.WMS(
        "<%= clean_layer %>",  "<%= SiteConfig.geoserver_url + '/wms' %>",
        {
          layers: "<%= clean_layer %>"
        },
        {isBaseLayer: false}
      );

      map.addLayer(<%= clean_layer %>);
    <% end %>

    var centerPoint = new OpenLayers.LonLat(bounds.getCenterLonLat());
    //console.log('centerPoint', bounds.getCenterLonLat());
     //map.setCenter(centerPoint);
    map.zoomToExtent(bounds.toBBOX());
    //map.zoomTo(map.getZoomForExtent(bounds));
    //map.zoomToMaxExtent();



})();
</script>

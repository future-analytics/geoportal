<% @service_base = SiteConfig.geoserver_url + "/" + @workspace %>


<div class="content">
  <h1><%= @doc.title %></h1>

  <div id="item_map"></div>

  <div id="categories">
    <h2>Categories</h2>
    <% @doc.categories.each do |category| %>
      <% search_string = "/items?q=#{category.content}&s=1&c=5&dt=3000" %>
       <a href="<%= search_string %>"><%= category.content %></a>
    <% end %>
  </div>

  <div id="keywords">
  <h2>Keywords</h2>
  <% @doc.keywords.each do |keyword| %>
    <% search_string = "/items?q=#{keyword.content}&s=1&c=5&dt=3000" %>
    <a href="<%= search_string %>"><%= keyword.content %></a>
  <% end %>
  </div>

  <% unless @doc.web_service.first.nil? %>

    <!-- TODO: refactor in to reflector classes on an item object -->
  <% wms_link = "#{@service_base}/wms?request=getCapabilities"%>
  <% wfs_link = "#{@service_base}/wfs?request=getCapabilities"%>

  <!-- this is from Geonetwork -->
  <% layer_list = @doc.layers.to_a.join(',') %>

  <div id="arcgis_connection">
    <h3>ArcGIS Connection</h3>
    <p><strong>WMS</strong>: <a href="<%= wms_link %>"><%= wms_link %></a></p>
    <p><strong>WFS</strong>: <a href="<%= wfs_link %>"><%= wfs_link %></a></p>
  </div>

  <div id="neatline_connection">
    <h3>Neatline Connection</h3>
    <p><strong>WMS Address</strong>: <%= "#{@service_base}/wms" %><p>
    <p><strong>Layers</strong>: <%= layer_list %></p>
  </div>

  <div id="layers">
    <h3>All Layers</h3>

    <% kml_layers_link = kml_url(layer_list) %>

    (<%= link_helper(kml_layers_link, 'KML') %>)

    <h3>Individual Layers</h3>

    <% @doc.layers.each do |layer| %>
      <p>
      <strong><%= layer.content %></strong> (
        <%= link_to(pdf_url(layer), 'PDF') %>,
        <%= link_to(kml_url(layer), 'KML') %>,
        <%= link_to(jpeg_url(layer), 'JPEG') %>,
        <%= link_to(ol_url(layer), 'Web Map', :class => 'cboxElement ajax') %>
        )
      </p>
  <% end %>

  </div>
<% end %>

  <div id="abstract">
    <h2>Abstract</h2>
    <p><%= @doc.abstract.gsub(/\n/, '<br/>') %></p>
  </div>
</div>

<% content_for :jsfooter do %>
  <%# TODO: refactor in to partial %>
<script>

(function() {
  "use strict";
//todo make this modular
  OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;
  OpenLayers.Util.onImageLoadErrorColor = "transparent";
  OpenLayers.ImgPath = "http://js.mapbox.com/theme/dark/";

  var bounds = new OpenLayers.Bounds(
    <%= @doc.west %>,
    <%= @doc.south  %>,
    <%= @doc.east %>,
    <%= @doc.north  %>
  );

   var map = new OpenLayers.Map('item_map', {
    projection: new OpenLayers.Projection("EPSG:4326"),
    displayProjection: new OpenLayers.Projection("EPSG:4326"),
    maxExtent: bounds,
    maxResolution: 'auto',
    controls: [
      new OpenLayers.Control.Attribution(),
      new OpenLayers.Control.Navigation(),
      new OpenLayers.Control.PanZoomBar(),
      new OpenLayers.Control.LayerSwitcher({
        'ascending': true,
        roundedCorner: false
      }),
      new OpenLayers.Control.ScaleLine(),
      new OpenLayers.Control.MousePosition()
    ]
   });

  <% @doc.layers.each do |layer| %>
    <% clean_layer = /\:(.*)/.match(layer.text)[1].to_s %>

    var <%= clean_layer %> = new OpenLayers.Layer.WMS(
      "<%= clean_layer %>",  "<%= SiteConfig.geoserver_url + '/wms' %>",
      { layers: "<%= layer.text %>", transparent: true, format: 'image/gif' },
      { isBaseLayer: true }
    );

    map.addLayer(<%= clean_layer %>);
  <% end %>

  map.zoomToMaxExtent();
})();
</script>


<script src="/js/vendor/jquery.colorbox-min.js"></script>
<script>$(document).ready(function(){
$(".ajax").colorbox({iframe: true, width:"80%", height:"80%"}});
});
</script>

<% end %>
